name: Pause Shijim Cloud

on:
  schedule:
    # UTC 時間 05:50 = 台灣時間 13:50
    # 週一到週五執行
    - cron: '50 5 * * 1-5'
  workflow_dispatch: # 允許手動按鈕觸發

jobs:
  pause-services:
    runs-on: ubuntu-latest
    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install Azure Container Apps Extension
      run: az extension add --name containerapp --upgrade

    - name: Pause ClickHouse (Allow Scale to 0)
      run: |
        # [修正] max-replicas 設為 1 (最小值)，min-replicas 設為 0 (允許暫停)
        az containerapp update --name clickhouse --resource-group shijim-rg --min-replicas 0 --max-replicas 1

    - name: Pause Workers (Allow Scale to 0)
      run: |
        # Workers 會在 13:45 自動結束程式，這裡將 min 設為 0 讓它們結束後不再重啟
        for i in {0..4}; do
          az containerapp update --name "shijim-worker-$i" --resource-group shijim-rg --min-replicas 0 --max-replicas 1
        done