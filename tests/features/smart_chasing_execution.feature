Feature: 智能追價執行策略 (Smart Chasing Execution)
  為了 在波動市場中以最優價格成交並避免落後
  作為 量化策略引擎
  我要求 系統能維護訂單狀態機，並根據價格偏離度與 OFI 信號自動執行「撤單重發 (Cancel/Replace)」。

  # ---------------------------------------------------------------------------
  # 背景：策略參數與初始狀態
  # ---------------------------------------------------------------------------
  Background: 引擎初始化
    Given 策略配置參數:
      | Parameter      | Value |
      | ChaseThreshold | 2.0   |
      | MaxChaseRound  | 3     |
    And 策略處於 WORKING 狀態
    And 目前掛有一個買單: Price=100.0, Qty=1

  # ---------------------------------------------------------------------------
  # 場景 1: 價格飛離觸發追價 (Standard Chasing)
  # ---------------------------------------------------------------------------
  Scenario: 市場最佳買價上漲超過閾值
    Given 市場最佳買價變為 103.0 (偏離 3.0 > 2.0)
    And OFI 為 0 (中性)
    When 引擎處理該 Tick
    Then 引擎應發出 CancelReplace 请求
    And 新訂單價格應設為 103.0
    And 狀態機應轉移至 CHASING

  # ---------------------------------------------------------------------------
  # 場景 2: OFI 輔助的激進追價 (Alpha Assisted Chasing)
  # ---------------------------------------------------------------------------
  Scenario: 強烈買壓下的追價
    Given 市場最佳買價變為 102.0 (偏離 2.0 = Threshold)
    And OFI 為 +10
    When 引擎處理該 Tick
    Then 引擎應立即發出 CancelReplace
    And 新訂單價格應設為 102.0
    And 記錄決策原因為 "AlphaDriven"

  # ---------------------------------------------------------------------------
  # 場景 3: 逆勢保護 (Adverse Selection Protection)
  # ---------------------------------------------------------------------------
  Scenario: 賣壓沉重時暫緩追價
    Given 市場最佳買價變為 102.5 (偏離 2.5 > 2.0)
    But OFI 為 -20
    When 引擎處理該 Tick
    Then 引擎不應發出追價請求
    And 狀態機應保持 WORKING
    And 記錄日誌 "Hold: Negative Alpha Protection"

  # ---------------------------------------------------------------------------
  # 場景 4: 狀態機防護 (State Guard)
  # ---------------------------------------------------------------------------
  Scenario: 追價中無視新信號
    Given 狀態機處於 CHASING 狀態
    When 市場價格上漲至 105.0
    Then 引擎不應發出任何新指令

  # ---------------------------------------------------------------------------
  # 場景 5: 追價次數上限 (Max Rounds)
  # ---------------------------------------------------------------------------
  Scenario: 達到最大追價次數
    Given 當前已追價次數為 3
    When 市場價格再次觸發追價條件
    Then 引擎應發出 Cancel 请求
    And 狀態機轉移至 IDLE
